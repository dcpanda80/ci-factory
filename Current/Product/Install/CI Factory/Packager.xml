<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="CI Factory Packager" default="Packager.Create">

  <property name="Common.Directory.ThirdParty.Path" value="C:\Projects\CI Factory\Current\Third Party"/>
  <property name="Common.Directory.Product.Path" value="C:\Projects\CI Factory\Current\Product"/>
	<property name="Common.Directory.Install.Path" value="${Common.Directory.Product.Path}\Install\CI Factory"/>
  <property name="ZipDirectory" value="${Common.Directory.Install.Path}\CI Factory"/>

  <target name="Packager.Create">

    <delete dir="${ZipDirectory}" if="${directory::exists(ZipDirectory)}"/>
    <mkdir dir="${ZipDirectory}"/>

    <copy file="${Common.Directory.Product.Path}\Production\CI Installer\Packages.csproj.remove" tofile="${ZipDirectory}\Packages.csproj" overwrite="True" />
    <copy file="${Common.Directory.Product.Path}\Production\CI Installer\CI Factory.sln.remove" tofile="${ZipDirectory}\CI Factory.sln" overwrite="True" />
    <copy file="${Common.Directory.Product.Path}\Production\CI Installer\run.bat" tofile="${ZipDirectory}\run.bat" overwrite="True" />
    <copy file="${Common.Directory.Product.Path}\Production\CI Installer\upgrade.bat" tofile="${ZipDirectory}\upgrade.bat" overwrite="True" />
    <copy file="${Common.Directory.Product.Path}\Production\CI Installer\CI Factory.URL" tofile="${ZipDirectory}\CI Factory.URL" overwrite="True" />
    <copy file="${Common.Directory.Product.Path}\Production\CI Installer\CI Factory Release Notes.html" tofile="${ZipDirectory}\CI Factory Release Notes.html" failonerror="false" overwrite="True" />

    <copy todir="${ZipDirectory}" includeemptydirs="true" overwrite="True">
      <fileset basedir="${Common.Directory.Product.Path}\Production\CI Installer" >
        <include name="Install Scripts\**\*"/>
      </fileset>
    </copy>
    
    <copy todir="${ZipDirectory}" includeemptydirs="true" overwrite="True">
      <fileset basedir="${Common.Directory.Product.Path}\Production\Foundation">
        <include name="Default\**\*"/>
        <exclude name="Default\Build\nAnt\**\*"/>
      </fileset>
    </copy>
      
    <copy todir="${ZipDirectory}\nAnt" includeemptydirs="true" overwrite="True" >
      <fileset basedir="${Common.Directory.ThirdParty.Path}\nAnt">
        <include name="**\*"/>
      </fileset>
    </copy>

    <copy todir="${ZipDirectory}" includeemptydirs="true" overwrite="True">
      <fileset basedir="${Common.Directory.Product.Path}\Production" defaultexcludes="false">
        <include name="Packages\**\*"/>
        <exclude name="Packages\CoverageEye"/>
        <exclude name="Packages\CoverageEye\**\*"/>
        <exclude name="Packages\CVS"/>
        <exclude name="Packages\CVS\**\*"/>
        <exclude name="Packages\StarTeam"/>
        <exclude name="Packages\StarTeam\**\*"/>
        <exclude name="Packages\TestCoverage"/>
        <exclude name="Packages\TestCoverage\**\*"/>
        <exclude name="Packages\Tracker"/>
        <exclude name="Packages\Tracker\**\*"/>
        <exclude name="Packages\Packages.csproj"/>
        <exclude name="Packages\obj"/>
        <exclude name="Packages\obj\**\*"/>
        <exclude name="Packages\bin"/>
        <exclude name="Packages\bin\**\*"/>
        <exclude name="Packages\**\.svn"/>
        <exclude name="Packages\**\.svn\**\*"/>
      </fileset>
    </copy>

    <copy todir="${ZipDirectory}" overwrite="True">
      <fileset basedir="${Common.Directory.Product.Path}">
        <include name="Power Tools\**\*"/>
        <include name="Documentation\**\*"/>
        <include name="Licenses\**\*"/>
      </fileset>
    </copy>

    <!--<zip includeemptydirs="true" zipfile="${ZipDirectory}\CIFactory.zip" >
      <fileset basedir="${ZipDirectory}" defaultexcludes="false">
        <include name="**\*"/>
      </fileset>
    </zip>-->

		<largeproperty name="SfxConfig.Content">
			<value expand="true" xml="false">
				<![CDATA[;The comment below contains SFX script commands

Path=C:\Tools
SavePath
Title=Extract CI Factory
]]>
			</value>
		</largeproperty>

		<property name="SfxConfig.FilePath" value="${Common.Directory.Install.Path}\SfxConfig.txt"/>
		<echo message="${SfxConfig.Content}" file="${SfxConfig.FilePath}"/>

		<property name="WinRarProgramPath" value="${environment::get-variable('ProgramFiles')}\winrar\winrar.exe" overwrite="false"/>
		<property name="CIFactorySetupExe.FilePath" value="${Common.Directory.Install.Path}\CIFactorySetup.exe"/>

		<delete file="${CIFactorySetupExe.FilePath}" if="${file::exists(CIFactorySetupExe.FilePath)}" />
		<exec program="${WinRarProgramPath}"
					commandline='a -m5 -iicon"${Common.Directory.Product.Path}\Images\cifactory.ico" -iimg"${Common.Directory.Product.Path}\Images\CIFactoryInstall.bmp" -r "${CIFactorySetupExe.FilePath}" "CI Factory" c -z"${SfxConfig.FilePath}" -sfx'
					workingdir='${Common.Directory.Install.Path}'/>

		<delete file="${SfxConfig.FilePath}" />
  </target>
  
</project>