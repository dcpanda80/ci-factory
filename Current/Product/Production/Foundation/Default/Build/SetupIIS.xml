<?xml version="1.0" encoding="utf-8" ?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="BuildServerSetup" default="Setup">
  
  <script language="C#" prefix="directory" >
    <imports>
      <import namespace="System.IO" />
    </imports>

    <code>
      <![CDATA[
         [Function("name")]
         public static string GetDirectoryName(string path)
         {
                 return new DirectoryInfo( path ).Name;
         }
		     [Function("setcurrentdirectory")]
         public static void SetCurrentDirectory(string path)
         {
                 Directory.SetCurrentDirectory(path);
         }
      ]]>
    </code>
  </script>

  <property name="BuildDirectory" value="${project::get-base-directory()}" />
  <function execute="${directory::setcurrentdirectory(BuildDirectory)}"/>
  
  <property name="ProjectName" value="${directory::name('..\..\')}" />
  <property name="ProjectCodeLineName" value="${directory::name('..\')}" />
  
  <property name="PackagesDirectory" value="${BuildDirectory}\Packages"/>
  <property name="ArtifactRootDirectory" value="${BuildDirectory}\Artifacts"/>
  <property name="CCNETDashboard.DashboardDirectory" value="${BuildDirectory}\dashboard"/>
  
  <target name="Setup" >
    <mkiisdir dirpath="${CCNETDashboard.DashboardDirectory}" vdirname="${ProjectName}-${ProjectCodeLineName}"  defaultdoc="Default.aspx" enabledefaultdoc="true"/>
    <mkiisdir dirpath="${ArtifactRootDirectory}" vdirname="${ProjectName}-${ProjectCodeLineName}/Artifacts" enabledirbrowsing="true"/>
    <mkiisdir dirpath="${PackagesDirectory}" vdirname="${ProjectName}-${ProjectCodeLineName}/Packages"/>
    <exec program="${framework::get-framework-directory('net-2.0')}\aspnet_regiis.exe" commandline="-s W3SVC/1/ROOT/${ProjectName}-${ProjectCodeLineName}" />

		<property name="APPCMDPath" value="${environment::get-variable('systemroot')}\system32\inetsrv\APPCMD.EXE"/>
		<exec program='${APPCMDPath}' 
					commandline='set app "Default Web Site/${ProjectName}-${ProjectCodeLineName}" /applicationPool:"Classic .NET AppPool"'
					if='${file::exists(APPCMDPath)}'/>
    <exec program='${APPCMDPath}'
					commandline='set app "Default Web Site/${ProjectName}-${ProjectCodeLineName}/Packages" /applicationPool:"Classic .NET AppPool"'
					if='${file::exists(APPCMDPath)}'/>
    <exec program='${APPCMDPath}'
					commandline='set app "Default Web Site/${ProjectName}-${ProjectCodeLineName}/Artifacts" /applicationPool:"Classic .NET AppPool"'
					if='${file::exists(APPCMDPath)}'/>
  </target>
  
</project>