<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Arguments">
  <!--Use Install.Package to install one or more Packages to an existing CI Factory Project.-->
  <property name="Install.Action" value="Install.Project" />
  
  <!--For Help: "file://C:\Tools\CI Factory\Documentation\Index.htm"-->
  
  <property name="ProjectName" value="TestProject" />
	<property name="CCNet.LabelPrefix" value="1.0.0."/>
	<property name="InitialVersion" value="1.0.0.0"/>

  <property name="Common.Directory.ProjectsRoot.Path"        value="c:\Projects"/>
  <property name="ProjectCodeLineName"      value="Current"/>
  <property name="Common.Directory.Product.Name"     value="Product"/>
  <property name="Common.Directory.ThirdParty.Name"  value="Third Party"/>
  <property name="Common.Directory.Production.Name"  value="Production"/>
  <property name="Common.Directory.UnitTest.Name"    value="Unit Test"/>
  <property name="Common.Directory.Install.Name"     value="Install"/>
  
  <include buildfile="Properties.Install.xml"/>
  <property name="CCNET.ServerName" value="${environment::get-machine-name()}"/>
  <property name="CCNET.ServerPort" value="21236"/>
  <property name="CCNET.RestPort"   value="21237"/>
  <property name="EmailHost"        value="127.0.0.1"/>
  <property name="CCNET.ModificationDelaySeconds" value="120"/>
  <property name="CCNET.IntervalTrigger" value="90"/>
  <property name="BuildMaster.Name" value="BuildMaster"/>
  <property name="BuildMaster.Email" value="fake@bogas.com"/>
  <largeproperty name="Developer.List">
    <value expand="true" xml="true">
      <user name="bill.smith" group="developer"  address="bill.smith@gmail.com"/>
    </value>
  </largeproperty>
  
  <property name="SVN.URI.Root" value="http://${ProjectName}.googlecode.com/svn"  />
  <property name="SVN.URI.ProjectName" value="${SVN.URI.Root}" /> <!--In a shared repo this might be "${SVN.URI.Root}/${ProjectName}"-->
  <property name="SVN.URI.ProjectCodeLine" value="${SVN.URI.ProjectName}/${ProjectCodeLineName}"/>

  <property name="CCNet.SVN.URI.ProjectName" value="http://&amp;ProjectName;.googlecode.com/svn" />
  <property name="CCNet.SVN.URI.ProjectCodeLine" value="${CCNet.SVN.URI.ProjectName}/&amp;ProjectCodeLineName;" />

  <property name="SVN.WebVisible" value="true" />
  <property name="CCNet.SVN.WebRepositoryUrl" value="http://&amp;ProjectName;.googlecode.com/svn"/>
  
  <property name="SVN.Credentials.SafeStorage" value="false"/><!--Set to true if you do not want the build users credentials stored in the repository for ?anyone? to see.-->
  <property name="SVN.Username" value="Build" />
  <property name="SVN.Password" value="password" />

  <property name="Coverage.UnitTestPackageInclude" value="${Common.Directory.Packages.Path.Ref}\DotNetUnitTest\UnitTest.Target.xml" />
  <property name="Coverage.UnitTestPropertiesInclude" value="${Common.Directory.Packages.Path.Ref}\DotNetUnitTest\UnitTest.Properties.xml" />
  <property name="NCover.IIS" value="false" />

  <strings id="Packages.InstallList">
    <string value="Subversion"/>
    <string value="CSDiff" />
    <string value="SourceModificationReport"/>
    <string value="Versioning"/>
    <string value="MSBuild" />
    <string value="NCover" />
    <string value="DotNetUnitTest"/>
    <string value="nDepend"/>
    <string value="FxCop"/>
    <string value="Simian" />
    <string value="Analytics" />
    <string value="Alerts" />

    <string value="Publish"/>
    <string value="Workspace"/>

    <!--
    <string value="LinesOfCode"/>
    <string value="VisualSourceSafe"/>
    <string value="Perforce"/>
    <string value="Ant"/>
    <string value="Backup" />
    <string value="VS.NETCompile"/>
    <string value="MSTest" />
    <string value="Tracker"/>
    <string value="InstallShield"/>
		<string value="Vault"/>
    <string value="VSTSVersionControl" />
    -->
  </strings>

  <target name="Post.Install">
    <exec
      program="${Common.Directory.Tools.Path}\nAnt\bin\nant.exe"
      workingdir="${Common.Directory.Build.Path}"
      verbose="True"
    >
      <arg line="/f:Scratch.build.xml"/>
      <arg line="rebuild-setups"/>
    </exec>
    <exec
      program="${Common.Directory.Tools.Path}\nAnt\bin\nant.exe"
      workingdir="${Common.Directory.Build.Path}"
      verbose="True"
    >
      <arg line="/f:UpdatenAntSchema.xml"/>
    </exec>
    
    <call target="SetOrderForVersioning"/>
    <call target="SetOrderForCSDiff"/>
    <call target="CleanExtraXmlNs"/>

    <exec
      program="${Common.Directory.Tools.Path}\nAnt\bin\nant.exe"
      workingdir="${Common.Directory.Build.Path}"
      verbose="True"
    >
      <arg line="/f:Scratch.build.xml"/>
      <arg line="SourceControl.Repository.Load"/>
    </exec>

    <exec
      program="${Common.Directory.Tools.Path}\nAnt\bin\nant.exe"
      workingdir="${Common.Directory.Build.Path}"
      verbose="True"
    >
      <arg line="/f:SetupIIS.xml"/>
    </exec>

    <asyncexec workingdir="${Common.Directory.Build.Path}" program="${CCNET.BatchFile}" createnowindow="false" redirectoutput="false" useshellexecute="true" waitforexit="false" />
    <asyncexec workingdir="${Common.Directory.Build.Path}" program="${BuildVS.OpenSolutionBat}" createnowindow="false" redirectoutput="false" useshellexecute="true" waitforexit="false" />
  </target>

  <target name='CleanExtraXmlNs'>
    <property name="BuildScript.File.Path" value="${Common.Directory.Build.Path}\Main.build.xml"/>
    <strings id="Build.Targets">
      <string value="Triggered"/>
      <string value="Heavy"/>
      <string value="Release"/>
      <string value="Deploy"/>
      <string value="Test"/>
    </strings>
    <call target="DoCleanExtraXmlNs"/>
    
    <property name="BuildScript.File.Path" value="${Common.Directory.Build.Path}\Post.build.xml"/>
    <strings id="Build.Targets">
      <string value="PostBuild"/>
    </strings>
    <call target="DoCleanExtraXmlNs"/>
  </target>
  
  <target name='DoCleanExtraXmlNs'>
    <loopthrough property="Target">
      <items>
        <strings refid="Build.Targets"/>
      </items>
      <do>
        <xmlpeek
          file="${BuildScript.File.Path}"
          property="Tasks"
          outerxml="true"
          xpath="/n:project/n:target[@name = '${Target}']/n:trycatch/n:try/*|/n:project/n:target[@name = '${Target}']/n:trycatch/n:try/comment()"
        >
          <namespaces>
            <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
          </namespaces>
        </xmlpeek>

        <property name='Tasks' value="${string::replace(Tasks, 'xmlns=&quot;&quot;', '')}"/>

        <xmlpoke
          file="${BuildScript.File.Path}"
          pokemode='Replace'
          value='${Tasks}'
          xpath="/n:project/n:target[@name = '${Target}']/n:trycatch/n:try"
        >
          <namespaces>
            <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
          </namespaces>
        </xmlpoke>
      </do>
    </loopthrough>
  </target>

  <target name='SetOrderForCSDiff'>
    <xmlpoke
      file="${Common.Directory.Build.Path}\Main.build.xml"
      pokemode="ReplaceOuter"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:call[@target ='SourceModificationReport.PublishNewSource']"
      value=''
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpoke>

    <xmlpoke
      file="${Common.Directory.Build.Path}\Main.build.xml"
      pokemode="After"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:call[@target ='SourceControl.CleanGetOf.Common.Directory.Product.Path']"
      value='&lt;call target="SourceModificationReport.PublishNewSource" /&gt;'
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpoke>

    <xmlpoke
      file="${Common.Directory.Build.Path}\Main.build.xml"
      pokemode="ReplaceOuter"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:call[@target ='SourceModificationReport.PublishOldSource']"
      value=''
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpoke>

    <xmlpoke
      file="${Common.Directory.Build.Path}\Main.build.xml"
      pokemode="After"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:description[text() ='Begin Pre Build Actions']"
      value='&lt;call target="SourceModificationReport.PublishOldSource" /&gt;'
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpoke>
  </target>

  <target name='SetOrderForVersioning'>
    <xmlpeek
      file="${Common.Directory.Build.Path}\Main.build.xml"
      property="trash"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:call[@target ='Versioning.IncrementBuildNumberOfProduct']"
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpeek>

    <xmlpoke
      file="${Common.Directory.Build.Path}\Main.build.xml"
      pokemode="ReplaceOuter"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:call[@target ='Compile.CompileSource']"
      value=''
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpoke>

    <xmlpoke
      file="${Common.Directory.Build.Path}\Main.build.xml"
      pokemode="After"
      xpath="/n:project/n:target[@name = 'Triggered']/n:trycatch/n:try/n:call[@target ='Versioning.IncrementBuildNumberOfProduct']"
      value='&lt;call target="Compile.CompileSource" /&gt;'
    >
      <namespaces>
        <namespace prefix='n' uri='http://nant.sf.net/schemas/nant.xsd' />
      </namespaces>
    </xmlpoke>
  </target>
  
</project>