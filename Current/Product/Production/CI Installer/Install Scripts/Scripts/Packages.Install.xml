<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="PackagesInstaller" >

	<property name="IsUpgrade" value="false" overwrite="false"/>

  <property name="Packages.CurrentPackage.PackageType" value=""/>
  <property name="Packages.CurrentPackage.PackageName" value=""/>
  <property name="Packages.CurrentPackage.SkipMainBuildInclucion" value="false" />

  <largeproperty name="Private.Packages.PreBuildActions.EndTag">
    <value xml="false"><![CDATA[<description>End Pre Build Actions</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.CleanUpActions.EndTag">
    <value xml="false"><![CDATA[<description>End Clean Up Actions</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.CompileActions.EndTag">
    <value xml="false"><![CDATA[<description>End Compile Actions</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.VarificationActions.EndTag">
    <value xml="false"><![CDATA[<description>End Varification Actions</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.PostBuildActions.EndTag">
    <value xml="false"><![CDATA[<description>End Post Build Actions</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.TearDown.EndTag">
    <value xml="false"><![CDATA[<description>End TearDowns</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.SetUp.EndTag">
    <value xml="false"><![CDATA[<description>End SetUps</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.Include.EndTag">
    <value xml="false"><![CDATA[</loadpackages>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.AddSetUp.EndTag">
    <value xml="false"><![CDATA[<description>End SetUps</description>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.AddTearDown.EndTag">
    <value xml="false"><![CDATA[<description>End TearDowns</description>]]></value>
  </largeproperty>

	<largeproperty name="Private.Packages.buildReportBuildPlugin.EndTag">
		<value>
			<![CDATA[</xslFileNames>
			</buildReportBuildPlugin>]]>
		</value>
	</largeproperty>

	<largeproperty name="Private.Packages.buildPlugins.EndTag">
    <value><![CDATA[</buildPlugins>]]></value>
  </largeproperty>

  <largeproperty name="Private.Packages.XslMerger.EndTag">
    <value>
      <![CDATA[</filepairs>
      </xslmerger>]]>
    </value>
  </largeproperty>

  <largeproperty name="Private.Packages.MergeFiles.EndTag">
    <value>
      <![CDATA[</files>
      </merge>]]>
    </value>
  </largeproperty>

  <largeproperty name="Private.Packages.PostBuild.EndTag">
    <value xml="false"><![CDATA[<description>End Post Build</description>]]></value>
  </largeproperty>

  <!-- These are private... -->

  <loopthrough property="Private.Packages.Install.PackageName">
    <items>
      <strings refid="Packages.InstallList"/>
    </items>
    <do>
      <property name="InstallScript" value="${SourcePackagesDirectory}\${Private.Packages.Install.PackageName}\Install\Install.xml"/>
      <echo message="${InstallScript}" />
      <ifthenelse  test="${file::exists(InstallScript)}">
        <then>
          <include buildfile="${InstallScript}" />
        </then>
        <else>
          <fail message="Installer for ${Private.Packages.Install.PackageName} not found: file not found - '${InstallScript}'."/>
        </else>
      </ifthenelse>
    </do>
  </loopthrough>

  <target name="Packages.Install" >
    <loopthrough property="Private.Packages.Install.PackageName">
      <items>
        <strings refid="Packages.InstallList"/>
      </items>
      <do>
        <call target="Packages.Reset.CurrentPackage" />
        <call target="${Private.Packages.Install.PackageName}.SetAsCurrentPackage"/>
        <call target="Packages.Validate.CurrentSetPackage"/>

        <property name="Packages.CopyPackage.PackageName" value="${Private.Packages.Install.PackageName}"/>
        <call target="Private.Packages.CopyPackage"/>

        <call target="Private.Packages.AddInclude" unless="${Packages.CurrentPackage.SkipMainBuildInclucion}" />
        <call target="Private.Packages.AddSetUp" unless="${Packages.CurrentPackage.SkipMainBuildInclucion}" />
        <call target="Private.Packages.AddTearDown" unless="${Packages.CurrentPackage.SkipMainBuildInclucion}" />

        <call target="${Private.Packages.Install.PackageName}.Install"/>
      </do>
    </loopthrough>
  </target>

  <target name="Packages.Reset.CurrentPackage">
    <property name="Packages.CurrentPackage.PackageType" value=""/>
    <property name="Packages.CurrentPackage.PackageName" value=""/>
    <property name="Current.BuildFile" value="${Common.Directory.Build.Path}\Main.Build.xml"/>
    <property name="Packages.CurrentPackage.SkipMainBuildInclucion" value="false" />

    <strings id="NAnt.Main.Targets">
      <string value="Triggered"/>
      <string value="Heavy"/>
      <string value="Release"/>
    </strings>

    <strings id="CCNet.Build.Types">
      <string value="Dev"/>
      <string value="Heavy"/>
      <string value="Release"/>
    </strings>
  </target>

  <target name="Packages.Validate.CurrentSetPackage">
    <fail if="${Packages.CurrentPackage.PackageName == ''}" message="PackageName was not set as the current package."/>
  </target>

  <property name="Packages.CopyPackage.PackageName" value=""/>

  <target name="Private.Packages.CopyPackage" >
    <mkdir dir="${Common.Directory.Packages.Path}\${Packages.CopyPackage.PackageName}"/>
    <copy todir="${Common.Directory.Packages.Path}" overwrite="true" >
      <fileset basedir="${SourcePackagesDirectory}">
        <include name="${Packages.CopyPackage.PackageName}\**\*"/>
        <exclude name="${Packages.CopyPackage.PackageName}\Install" />
        <exclude name="${Packages.CopyPackage.PackageName}\Install\**\*"/>
				<exclude name="${Packages.CopyPackage.PackageName}\Upgrade" />
				<exclude name="${Packages.CopyPackage.PackageName}\Upgrade\**\*"/>
        <exclude name="${Packages.CopyPackage.PackageName}\Product" />
        <exclude name="${Packages.CopyPackage.PackageName}\Product\**\*"/>
        <exclude name="${Packages.CopyPackage.PackageName}\**\*.xml"/>
        <exclude name="${Packages.CopyPackage.PackageName}\**\*.txt"/>
        <exclude name="${Packages.CopyPackage.PackageName}\**\*.xsl"/>
      </fileset>
    </copy>
    <copy todir="${Common.Directory.Packages.Path}" overwrite="true">
      <fileset basedir="${SourcePackagesDirectory}">
        <include name="${Packages.CopyPackage.PackageName}\**\*.xml"/>
        <include name="${Packages.CopyPackage.PackageName}\**\*.txt"/>
        <include name="${Packages.CopyPackage.PackageName}\**\*.xsl"/>
        <exclude name="${Packages.CopyPackage.PackageName}\Install\**\*"/>
        <exclude name="${Packages.CopyPackage.PackageName}\Install" />
        <exclude name="${Packages.CopyPackage.PackageName}\Upgrade" />
        <exclude name="${Packages.CopyPackage.PackageName}\Upgrade\**\*"/>
        <exclude name="${Packages.CopyPackage.PackageName}\Product" />
        <exclude name="${Packages.CopyPackage.PackageName}\Product\**\*"/>
      </fileset>
      <filterchain refid="Common.FilterChain" />
    </copy>

    <copy todir="${Common.Directory.Product.Path}" overwrite="true">
      <fileset basedir="${SourcePackagesDirectory}\Product">
        <include name="**\*"/>
        <exclude name="**\*.bat"/>
      </fileset>
      <filterchain refid="Common.FilterChain" />
    </copy>

    <copy todir="${Common.Directory.Product.Path}" overwrite="true">
      <fileset basedir="${SourcePackagesDirectory}\Product">
        <exclude name="**\*.bat"/>
      </fileset>
    </copy>
  </target>


  <property name="Packages.AddMergeFiles.Block" value=""/>
  <target name="Packages.AddMergeFiles">
    <loopthrough property="CCNet.Build.Type">
      <items>
        <strings refid="CCNet.Build.Types"/>
      </items>
      <do>
        <xmlpoke
          file="${Common.Directory.Build.Path}\ccnetproject.xml"
          pokemode="Add"
          xpath="/cruisecontrol/project[@name='${ProjectName}-${ProjectCodeLineName}-${CCNet.Build.Type}']/publishers/merge/files"
          value="${Packages.AddMergeFiles.Block}"
        />
      </do>
    </loopthrough>
  </target>

  <property name="Packages.AddXslMerger.Block" value=""/>
  <target name="Packages.AddXslMerger" >
    <loopthrough property="CCNet.Build.Type">
      <items>
        <strings refid="CCNet.Build.Types"/>
      </items>
      <do>
        <xmlpoke
          file="${Common.Directory.Build.Path}\ccnetproject.xml"
          pokemode="Add"
          xpath="/cruisecontrol/project[@name='${ProjectName}-${ProjectCodeLineName}-${CCNet.Build.Type}']/publishers/xslmerger/filepairs"
          value="${Packages.AddXslMerger.Block}"
        />
      </do>
    </loopthrough>
  </target>

  <property name="Packages.AddbuildReportBuildPlugin.Block" value=""/>
  <target name="Packages.AddbuildReportBuildPlugin" >
    <largeproperty name="Private.Packages.DashboardConfig.Replace.To">
      <value xml="false" expand="true">
        <![CDATA[${Packages.AddbuildReportBuildPlugin.Block}
  ${Private.Packages.buildReportBuildPlugin.EndTag}]]>
      </value>
    </largeproperty>
    <property name="Private.Packages.DashboardConfig.Replace.From" value="${Private.Packages.buildReportBuildPlugin.EndTag}" />
    <call target="Private.Packages.DashboardConfig.Replace"/>
  </target>

  <property name="Packages.AddbuildPlugins.Block" value=""/>
  <target name="Packages.AddbuildPlugins" >
    <largeproperty name="Private.Packages.DashboardConfig.Replace.To">
      <value xml="false" expand="true">
        <![CDATA[${Packages.AddbuildPlugins.Block}
  ${Private.Packages.buildPlugins.EndTag}]]>
      </value>
    </largeproperty>
    <property name="Private.Packages.DashboardConfig.Replace.From" value="${Private.Packages.buildPlugins.EndTag}" />
    <call target="Private.Packages.DashboardConfig.Replace"/>
  </target>


  <target name="Private.Packages.AddInclude" unless="${IsUpgrade}">
    <ifthenelse test="${Packages.CurrentPackage.PackageType!=''}">
      <then>
        <largeproperty name="Private.Packages.MainBuild.SmartAddString.NewText">
          <value xml="false" expand="true">
            <![CDATA[<package name="${Packages.CurrentPackage.PackageName}" type="${Packages.CurrentPackage.PackageType}"/>]]>
          </value>
        </largeproperty>
      </then>
      <else>
        <largeproperty name="Private.Packages.MainBuild.SmartAddString.NewText">
          <value xml="false" expand="true">
            <![CDATA[<package name="${Packages.CurrentPackage.PackageName}" />]]>
          </value>
        </largeproperty>
      </else>
    </ifthenelse>

    <property name="Private.Packages.MainBuild.SmartAddString.BeforeText" value="${Private.Packages.Include.EndTag}"/>

    <call target="Private.Packages.MainBuild.SmartAddString"/>

    <if test="${Current.BuildFile == Common.Directory.Build.Path + '\Main.Build.xml'}">
      <property name="Current.BuildFile" value="${Common.Directory.Build.Path}\Scratch.build.xml"/>
      <call target="Private.Packages.MainBuild.SmartAddString"/>
      
      <property name="Current.BuildFile" value="${Common.Directory.Product.Path}\Scratch.build.xml"/>
      <call target="Private.Packages.MainBuild.SmartAddString"/>

      <property name="Current.BuildFile" value="${Common.Directory.Product.Path}\Personal.Build.xml"/>
      <call target="Private.Packages.MainBuild.SmartAddString"/>
      
      <property name="Current.BuildFile" value="${Common.Directory.Build.Path}\Main.Build.xml"/>
    </if>
  </target>


  <target name="Private.Packages.AddSetUp" unless="${IsUpgrade}">
		<largeproperty name="Private.Packages.MainBuild.SmartAddString.NewText">
			<value xml="false" expand="true">
				<![CDATA[<call target="${Packages.CurrentPackage.PackageName}.SetUp" />]]>
			</value>
		</largeproperty>

    <property name="Private.Packages.MainBuild.SmartAddString.BeforeText" value="${Private.Packages.AddSetUp.EndTag}"/>

    <call target="Private.Packages.MainBuild.SmartAddString"/>
  </target>


  <target name="Private.Packages.AddTearDown" unless="${IsUpgrade}">
    <largeproperty name="Private.Packages.MainBuild.SmartAddString.NewText">
      <value xml="false" expand="true">
        <![CDATA[<call target="${Packages.CurrentPackage.PackageName}.TearDown" />]]>
      </value>
    </largeproperty>

    <property name="Private.Packages.MainBuild.SmartAddString.BeforeText" value="${Private.Packages.AddTearDown.EndTag}"/>

    <call target="Private.Packages.MainBuild.SmartAddString"/>
  </target>


  <property name="Packages.AddPreBuildActions.Block" value=""/>
  <target name="Packages.AddPreBuildActions" unless="${IsUpgrade}">
    <AddCallToMainScript
      xmlfragment="${Packages.AddPreBuildActions.Block}"
      blockname="Pre Build">
      <strings refid="NAnt.Main.Targets"/>
    </AddCallToMainScript>
  </target>

  <property name="Packages.AddCleanUpActions.Block" value=""/>
  <target name="Packages.AddCleanUpActions" unless="${IsUpgrade}">
    <AddCallToMainScript
      xmlfragment="${Packages.AddCleanUpActions.Block}"
      blockname="Clean Up">
      <strings refid="NAnt.Main.Targets"/>
    </AddCallToMainScript>
  </target>

  <property name="Packages.AddCompileActions.Block" value=""/>
  <target name="Packages.AddCompileActions" unless="${IsUpgrade}">
    <AddCallToMainScript
      xmlfragment="${Packages.AddCompileActions.Block}"
      blockname="Compile">
      <strings refid="NAnt.Main.Targets"/>
    </AddCallToMainScript>
  </target>

  <property name="Packages.AddVarificationActions.Block" value=""/>
  <target name="Packages.AddVarificationActions" unless="${IsUpgrade}">
    <AddCallToMainScript
      xmlfragment="${Packages.AddVarificationActions.Block}"
      blockname="Varification">
      <strings refid="NAnt.Main.Targets"/>
    </AddCallToMainScript>
	</target>

	<property name="Packages.AddPostBuildActions.Block" value=""/>
	<target name="Packages.AddPostBuildActions" unless="${IsUpgrade}">
    <AddCallToMainScript
      xmlfragment="${Packages.AddPostBuildActions.Block}"
      blockname="Post Build">
      <strings refid="NAnt.Main.Targets"/>
    </AddCallToMainScript>
  </target>

  <property name="Private.Packages.MainBuild.Replace.To" value=""/>
  <property name="Private.Packages.MainBuild.Replace.From" value=""/>
  <target name="Private.Packages.MainBuild.Replace" unless="${IsUpgrade}">
		<replace file="${Current.BuildFile}">
			<filterchain>
				<replacestring from="${Private.Packages.MainBuild.Replace.From}" to="${Private.Packages.MainBuild.Replace.To}" />
			</filterchain>
		</replace>
	</target>

  <property name="Private.Packages.MainBuild.SmartAddString.BeforeText" value=""/>
  <property name="Private.Packages.MainBuild.SmartAddString.NewText" value=""/>
  <target name="Private.Packages.MainBuild.SmartAddString" unless="${IsUpgrade}">
    <script language="C#">
      <imports >
        <import namespace="System.Xml"/>
        <import namespace="NAnt.Core.Types" />
      </imports >
      <code>
        <![CDATA[
public static void ScriptMain(NAnt.Core.Project project)
{
  string buildFile = project.Properties["Current.BuildFile"];


  string beforeText = project.Properties["Private.Packages.MainBuild.SmartAddString.BeforeText"];
  if (String.IsNullOrEmpty(beforeText))
    throw new ArgumentNullException("Private.Packages.MainBuild.SmartAddString.BeforeText");
  string newText = project.Properties["Private.Packages.MainBuild.SmartAddString.NewText"];
  if (String.IsNullOrEmpty(newText))
    throw new ArgumentNullException("Private.Packages.MainBuild.SmartAddString.NewText");

  string documentOuterText = File.ReadAllText(buildFile);

  // We normalize white space
  documentOuterText = Normalize(documentOuterText);
  newText = Normalize(newText);

  // Don't add the same text repeatedly
  if (documentOuterText.IndexOf(newText) == -1)
  {    
    //Console.WriteLine(newText);
    //Console.WriteLine(documentOuterText);

    XmlDocument buildXmlDoc = new XmlDocument();
    buildXmlDoc.Load(buildFile);
    XmlNamespaceManager namespaces = new XmlNamespaceManager(buildXmlDoc.NameTable);
    namespaces.AddNamespace("nant", "http://nant.sf.net/schemas/nant.xsd");

    string documentOuterXml = buildXmlDoc.OuterXml;

    documentOuterXml = Normalize(documentOuterXml);
    beforeText = Normalize(beforeText);

    int beforeTextIndex = documentOuterXml.IndexOf(beforeText);
    if (beforeTextIndex < 0)
      throw new ApplicationException("Text not found: " + beforeText);


    documentOuterXml = documentOuterXml.Substring(0, beforeTextIndex) + newText + documentOuterXml.Substring(beforeTextIndex);

    buildXmlDoc.LoadXml( documentOuterXml);


    buildXmlDoc.PreserveWhitespace = false;
    buildXmlDoc.Save(buildFile);
  }


}

static string Normalize(string input)
{
  // We normalize white space
  input = input.Replace('\r', ' ');
  input = input.Replace('\n', ' ');
  input = input.Replace('\t', ' ');
  while (true)
  {
    int oldLength = input.Length;
    input = input.Replace("  ", " ");
    if (input.Length == oldLength) break;
  }

  // Normalize the space at the end of self-closing attributes
  input = input.Replace("\"/>", "\" />");

  return input;
}
        ]]>
      </code>
    </script>
  </target>


  <property name="Private.Packages.DashboardConfig.Replace.To" value=""/>
  <property name="Private.Packages.DashboardConfig.Replace.From" value=""/>
  <target name="Private.Packages.DashboardConfig.Replace" >
    <replace file="${Common.Directory.Build.Path}\dashboard\dashboard.config">
      <filterchain>
        <replacestring from="${Private.Packages.DashboardConfig.Replace.From}" to="${Private.Packages.DashboardConfig.Replace.To}" />
      </filterchain>
    </replace>
  </target>

  <property name="Private.Packages.CCNETProjectConfig.Replace.To" value=""/>
  <property name="Private.Packages.CCNETProjectConfig.Replace.From" value=""/>
  <target name="Private.Packages.CCNETProjectConfig.Replace" >
    <replace file="${Common.Directory.Build.Path}\ccnetproject.xml">
      <filterchain>
        <replacestring from="${Private.Packages.CCNETProjectConfig.Replace.From}" to="${Private.Packages.CCNETProjectConfig.Replace.To}" />
      </filterchain>
    </replace>
  </target>

  <target name="Packages.ValidateParameters">
    <loopthrough property="Private.Packages.Install.PackageName">
      <items>
        <strings refid="Packages.InstallList"/>
      </items>
      <do>
        <call target="${Private.Packages.Install.PackageName}.ValidateParameters"/>
      </do>
    </loopthrough>
  </target>

  <macrodef name="AddCallToMainScript">
    <attributes>
      <attribute name="xmlfragment" require="true" type="string"/>
      <attribute name="blockname" require="true" type="string"/>
    </attributes>
    <elements>
      <element name="strings" require="True" type="CIFactory.NAnt.Types.StringList"/>
    </elements>
    <sequential>
      <loopthrough property="NAnt.Main.Target">
        <items>
          <element name="strings"/>
        </items>
        <do>
          <xmlpoke
            file="${Current.BuildFile}"
            pokemode="Before"
            xpath="/nant:project/nant:target[@name = '${NAnt.Main.Target}']/nant:trycatch/n:try/nant:description[text()='End ${blockname} Actions']"
            value="${xmlfragment}"
        >
            <namespaces>
              <namespace prefix='nant' uri='http://nant.sf.net/schemas/nant.xsd' />
            </namespaces>
          </xmlpoke>
        </do>
      </loopthrough>
    </sequential>
  </macrodef>
  
</project>
