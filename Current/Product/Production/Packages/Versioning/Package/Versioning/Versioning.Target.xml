<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Versioning">

  <loadtasks assembly="Packages\Versioning\bin\UpdateVersion.Tasks.dll" />
  <include buildfile="Versioning.Properties.xml" />

  <!--
	The following properties should be specified in the calling script.
	
  <property name="Versioning.ProjectInformationFile" value="" />
  <property name="Versioning.ProjectInformationNewVersion" value="" />
  
  -->

  <!-- The following properties are for internal use only -->
  <property name="Private.Versioning.NewerThanDateTime" value="" />
  
  <target name="Versioning.IncrementBuildNumberOfModifiedAssemblies">
    <mkdir unless="${directory::exists(ProductionDirectory)}" dir="${ProductionDirectory}"/>
    <call target="SourceModificationReport.GetOldestModificationTime"/>
    <script language="VB">
      <code><![CDATA[
          
					Public Shared Sub ScriptMain(ByVal project As Project)
						Dim pd As PropertyDictionary = project.Properties
						Dim OldestModificationTime As DateTime = DateTime.Parse(pd("SourceModificationReport.OldestModificationTime"))
						OldestModificationTime.Subtract(New TimeSpan(0, 0, 0, 0, 1))
            pd("Private.Versioning.NewerThanDateTime") = OldestModificationTime.ToString
					End Sub
			    
			]]></code>
    </script>
    
    <property name="Private.Versioning.Directory" value="${BuildDirectory}\Versioning"/>
    <mkdir unless="${directory::exists(Private.Versioning.Directory)}" dir="${Private.Versioning.Directory}"/>
    <property name="Private.Versioning.ListOfAssemblyInfoFiles" value="${Private.Versioning.Directory}\ListOfAssemblyInfoFiles.txt"/>

    <GenerateAssemblyInfoList SearchDirectory="${ProductionDirectory}" DateTime="${Private.Versioning.NewerThanDateTime}" Output="${Private.Versioning.ListOfAssemblyInfoFiles}" SearchPattern="*.vb" />
    <GenerateAssemblyInfoList SearchDirectory="${ProductionDirectory}" DateTime="${Private.Versioning.NewerThanDateTime}" Output="${Private.Versioning.ListOfAssemblyInfoFiles}" SearchPattern="*.cs" Append="true" />

    <foreach item="File" property="Private.Versioning.AssemblyInfoFile">
      <in>
        <items>
          <includesfile name="${Private.Versioning.ListOfAssemblyInfoFiles}"/>
        </items>
      </in>
      <do>
        <property name="SourceControl.CheckOut.File" value="${Private.Versioning.AssemblyInfoFile}"/>
        <call target="SourceControl.CheckOut"/>
        <IncrementAssemblyVersion File="${Private.Versioning.AssemblyInfoFile}"/>
        <property name="SourceControl.CheckIn.File" value="${Private.Versioning.AssemblyInfoFile}"/>
        <call target="SourceControl.CheckIn"/>
      </do>
    </foreach>

  </target>

  <target name="Versioning.IncreamentBuildNumberOfProduct">
    <foreach item="File" property="ReplaceFile">
      <in>
        <items>
          <include name="${Versioning.ProductInformationFileLocation}\**\${Versioning.ProductInformationFile}"/>
        </items>
      </in>
      <do>
        <property name="SourceControl.CheckOut.File" value="${ReplaceFile}"/>
        <call target="SourceControl.CheckOut"/>
        <UpdateProductVersion File="${ReplaceFile}" Version="${Versioning.ProductVersion}" />
        <property name="SourceControl.CheckIn.File" value="${ReplaceFile}"/>
        <call target="SourceControl.CheckIn"/>
      </do>
    </foreach>
    
  </target>

  <target name="Versioning.FixUp">
    <property name="Versioning.FixUp.XPath.AssemblyInfo" value="b:Project/b:ItemGroup[b:Compile[@Include = 'Properties\AssemblyInfo.cs']]"/>
    <property name="Versioning.FixUp.XPath.ProjectInfo" value="b:Project/b:ItemGroup/b:Compile[contains(@Include,'ProjectInfo.cs')]"/>
    <property name="Versioning.FixUp.XPath.Items" value="b:Project/b:ItemGroup[b:Compile[@Include = 'Properties\AssemblyInfo.cs']]/b:Compile"/>

    <largeproperty name="Versioning.FixUp.XPath.Replacment" >
      <value xml="false" expand="true">
        <![CDATA[
        <Compile Include="${ProductDirectory}\ProjectInfo.cs">
          <Link>Properties\ProjectInfo.cs</Link>
        </Compile>
]]>
      </value>
    </largeproperty>

    <foreach item="File" property="File" >
      <in>
        <items>
          <include name="C:\Projects\CI Factory\Current\Product\Production\CCNet\CCNET.Dashboard.Extensions.Plugin\CCNET.Dashboard.Extensions.Plugin.csproj"/>
        </items>
      </in>
      <do>
        <property name="Versioning.FixUp.ShouldProcess" value="true"/>
        <trycatch>
          <try>
            <xmlpeek 
              file="${File}"
              nodeindex="0"
              property="Trash"
              xpath="${Versioning.FixUp.XPath.ProjectInfo}"
              >
              <namespaces>
                <namespace prefix="b" uri="http://schemas.microsoft.com/developer/msbuild/2003"/>
              </namespaces>
            </xmlpeek>
            <property name="Versioning.FixUp.ShouldProcess" value="false"/>
          </try>
          <catch>
            <echo message="Need to add ProjectInfo to ${File}"/>
          </catch>
        </trycatch>

        <if test="${Versioning.FixUp.ShouldProcess}">
          <property name="Versioning.FixUp.XPath.Items.Return" value="${myxml::get-xml(File, Versioning.FixUp.XPath.Items, 'b', 'http://schemas.microsoft.com/developer/msbuild/2003')}"/>
          <xmlpoke 
            file="${File}"
            value="${Versioning.FixUp.XPath.Replacment}${Versioning.FixUp.XPath.Items.Return}"
            xpath="${Versioning.FixUp.XPath.AssemblyInfo}"
          >
            <namespaces>
              <namespace prefix="b" uri="http://schemas.microsoft.com/developer/msbuild/2003"/>
            </namespaces>
          </xmlpoke>

          <largeproperty name="AssemblyProduct" >
            <value xml="false"><![CDATA[\[assembly\: AssemblyProduct\(\".*\"\)]]]></value>
          </largeproperty>

          <property name="AssemblyInfo" value="${path::get-directory-name(File)}\Properties\AssemblyInfo.cs"/>

          <copy file="${AssemblyInfo}" tofile="${AssemblyInfo}" overwrite="true" >
            <filterchain>
              <regexreplace replacment="" pattern="${AssemblyProduct}" lines="1" />
            </filterchain>
          </copy>
        </if>
      </do>
    </foreach>
  </target>
  
  <target name="Versioning.SetUp">

  </target>

  <target name="Versioning.TearDown">

  </target>

</project>