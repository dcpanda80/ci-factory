<?xml version="1.0" encoding="utf-8" ?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Alerts.UnitTests.Scripts">

  <property name="Alerts.UnitTests.PreviousPropertiesFilePath" value="${PackagesDirectory}\Alertss\UnitTests\Previous.Properties.xml"/>
  <ifthenelse test="${file::exists(Alerts.UnitTests.PreviousPropertiesFilePath)}">
    <then>
      <include buildfile="${Alerts.UnitTests.PreviousPropertiesFilePath}" />
    </then>
    <else>
      <echo level="Warning" message="File Does Not Exist: ${Alerts.UnitTests.PreviousPropertiesFilePath}"/>
    </else>
  </ifthenelse>
  

  <!-- Begin Previous Properties -->
  <property name="Alerts.UnitTests.Previous.Count" value="NaN" overwrite="false"/>
  <!-- End Previous Properties -->

  <target name="Alerts.UnitTests">

    <xmlpeek 
      file="${Alertss.BuildLog}" 
      xpath="//Tests/TestRun/result/totalTestCount" 
      property="Alerts.UnitTests.Count"
      nodeindex="0"
    />

    <xmlquery id="ProjectPaths"
      file="${Alertss.BuildLog}" 
      query="//modification/project" 
    />

    <property name="AreChangesFromThisBuild" value="False"/>

    <loopthrough property="ProjectPath">
      <items>
        <xmlquery refid="ProjectPaths"/>
      </items>
      <do>
        <property name="Found" value=""/>
        <regex input="${ProjectPath}" pattern="(?'Found'^\$/dod\.ahlta/Current/Product/Unit Test).*" options="IgnoreCase" failonerror="false"/>
        <if test="${Found != ''}">
          <property name="AreChangesFromThisBuild" value="True"/>
        </if>
      </do>
    </loopthrough>

    <echo message="Unit Test Count is ${Alerts.UnitTests.Count}"/>

    <property name="Alertss.SendMessage.ToList" value="${Alertss.Developer.Email}" />
    <property name="Alertss.SendMessage.CCList" value="${Alertss.Message.CCList};jason_ray@CHCSII.com" />

    <echo message="Previous Unit Test Count is ${Alerts.UnitTests.Previous.Count}"/>

    <if test="${Alerts.UnitTests.Previous.Count != 'NaN' and bool::parse(AreChangesFromThisBuild) == true}">
      <ifthenelse test="${Alerts.UnitTests.Count > Alerts.UnitTests.Previous.Count}">
        <then>
          <call target="Alerts.UnitTests.GenerateThankYou"/>
          <call target="Alertss.SendMessage"/>
        </then>
        <elseif if="${Alerts.UnitTests.Previous.Count > Alerts.UnitTests.Count}">
          <call target="Alerts.UnitTests.GenerateWarning"/>
          <call target="Alertss.SendMessage"/>
        </elseif>
      </ifthenelse>
    </if>

    <saveproperties file="${Alerts.UnitTests.PreviousPropertiesFilePath}" format="Include">
      <property name="Alerts.UnitTests.Previous.Count" value="${Alerts.UnitTests.Count}"/>
    </saveproperties>

  </target>

  <target name="Alerts.UnitTests.GenerateThankYou">
    <property name="Alertss.SendMessage.Subject" value="${CCNetLabel}: Thanks For Adding More Unit Tests" />

    <largeproperty name="Alertss.SendMessage.Content">
      <value expand="true" xml="true">
        <html>
          <head>
          </head>
          <body>
            <p>${datetime::now()}</p>
            <p>
              <a href="${UrlToThisBuild}">${CCNetLabel}</a>
            </p>

            <p>${Alertss.Developer.Name},</p>
            <p>Thank you for increasing the number of unit tests from ${Alerts.UnitTests.Previous.Count} to ${Alerts.UnitTests.Count}.</p>
            <br/>
            <p>Cheers,</p>
            <p>Your pal, the build server.</p>
          </body>
        </html>
      </value>
    </largeproperty>
  </target>

  <target name="Alerts.UnitTests.GenerateWarning">
    <property name="Alertss.SendMessage.Subject" value="${CCNetLabel}: Did You Mean to Remove Unit Tests?" />

    <largeproperty name="Alertss.SendMessage.Content">
      <value expand="true" xml="true">
        <html>
          <head>
          </head>
          <body>
            <p>${datetime::now()}</p>
            <p>
              <a href="${UrlToThisBuild}">${CCNetLabel}</a>
            </p>

            <p>${Alertss.Developer.Name},</p>
            <p>Please take note that you have reduced the number of unit tests from ${Alerts.UnitTests.Previous.Count} to ${Alerts.UnitTests.Count}.</p>
            <br/>
            <p>Cheers,</p>
            <p>Your pal, the build server.</p>
          </body>
        </html>
      </value>
    </largeproperty>
  </target>
  
</project>