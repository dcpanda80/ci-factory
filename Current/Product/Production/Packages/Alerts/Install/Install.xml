<?xml version="1.0" encoding="utf-8" ?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Alerts.Install" default="Alerts.Install">

  <include buildfile="Properties.xml" />
  
  <target name="Alerts.Install">
    <strings id="NAnt.Main.Targets">
      <string value="PostBuild"/>
    </strings>
    <largeproperty name="Packages.AddPostBuildActions.Block">
      <value xml="false">
      <![CDATA[<call target="Alerts.Run" failonerror="false"/>]]></value>
    </largeproperty>
    <call target="Packages.AddPostBuildActions"/>

    <largeproperty name="Packages.AddbuildReportBuildPlugin.Block">
      <value xml="false"><![CDATA[<!-- Alerts should be the second build report plugin, behind Analytics (if you installed it). -->
      <xslFile>Packages\Alerts\AlertsSummary.xsl</xslFile>]]></value>
    </largeproperty>
    <call target="Packages.AddbuildReportBuildPlugin"/>

  </target>

  <target name="Alerts.SetAsCurrentPackage">
    <property name="Packages.CurrentPackage.PackageName" value="Alerts"/>
    <property name="Current.BuildFile" value="${Common.Directory.Build.Path}\Post.Build.xml"/>
  </target>

  <target name="Alerts.ValidateParameters">
    <property name="XmlDiffPath" value="${environment::get-variable('ProgramFiles')}\XmlDiffPatch\Bin\XmlDiff.exe"/>
    <if test="${stringlist::contains('Packages.InstallList', 'Simian')}">
      <call target="Alerts.EnsureXmlDiffInstallationExists"/>
    </if>
  </target>

  <target name="Alerts.EnsureXmlDiffInstallationExists" unless="${file::exists(XmlDiffPath)}">
    <ask answer="Answer"
           question="It looks like XmlDiff is not installed.  This software is required.  Do you wish to install the software?"
           caption="Proceed Without Required Software?"
           showdialog="true" >
      <options>
        <string value="Install"/>
        <string value="Exit"/>
        <string value="Continue without installing (NOT RECOMMENDED)"/>
      </options>
    </ask>
    <ifthenelse test="${Answer == 'Install'}">
      <then>
        <mkdir dir="C:\Temp" unless="${directory::exists('C:\Temp')}"/>
        <get dest="C:\Temp\xmldiffpatch.exe" src="http://download.microsoft.com/download/xml/Patch/1.0/WXP/EN-US/xmldiffpatch.exe"></get>
        <exec program="C:\Temp\xmldiffpatch.exe" verbose="true" />
      </then>
      <elseif if="${Answer == 'Exit'}">
        <fail message="Please install XmlDiff!" />
      </elseif>
    </ifthenelse>
  </target>


</project>