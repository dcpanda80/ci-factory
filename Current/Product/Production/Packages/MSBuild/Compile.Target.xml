<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Compile">

  <property name="Compile.FilesToDeleteAtSetup" value="" overwrite="false"/>
	<property name="Compile.ConfigName" value="debug" overwrite="false"/>
	<property name="Compile.ToCopyToBin" value="false" overwrite="false" />
  <property name="Compile.ToConvertLogFile" value="false" overwrite="false" />
  <property name="Compile.ToDeployZip" value="false" overwrite="false" />
  <property name="Compile.LogFileDirectory" value="${BuildDirectory}\CompileLogs" overwrite="false" />
  <property name="Compile.DevEnv" value="C:\Program Files\Microsoft Visual Studio 8\Common7\IDE\devenv.exe" overwrite="false"/>
	
  <include buildfile="Compile.Properties.xml" />

	<!--
	The following properties should be specified in the calling script.
	
	<property name="Compile.SolutionFile" value="" />
	<property name="Compile.Bin" value="" />
	<property name="Compile.XmlLogFileName" value="" />
	-->
	
	<!-- The following properties are for internal use only -->
  <property name="Private.Compile.Result" value="" />
    
  <target name="Compile.CompileSource">
    <exec 
	    program="C:\WINDOWS\Microsoft.NET\Framework\v2.0.50727\msbuild.exe"
	    commandline='"${Compile.SolutionFile}" /t:Build /p:Configuration="${Compile.ConfigName}" /noconsolelogger /verbosity:diagnostic /l:ThoughtWorks.CruiseControl.MsBuild.XmlLogger,"${PackagesDirectory}\VS.NETCompile\bin\ThoughtWorks.CruiseControl.MsBuild.dll";"${Compile.LogFileDirectory}\${Compile.XmlLogFileName}"'
	    failonerror="false"
	    resultproperty="Private.Compile.Result"
      verbose="true"
    >
      <environment refid="${Compile.Environment}" />
    </exec>
    <copy file="${Compile.LogFileDirectory}\${Compile.XmlLogFileName}" tofile="${Common.ArtifactDirectoryPath}\MSBuildLog.xml" if="${Compile.PublishLogFile}"/>
    <if test="${int::parse(Private.Compile.Result) != 0}">
      <fail message='The compilation failed, for details please click the link named "MSBuild Compile Details" on the left.' />
    </if>
    <call target="Private.Compile.CopyToWorkingBin" />
    <call target="Private.Compile.DeployZip" />
  </target>
    
  <target name="Private.Compile.CopyToWorkingBin" if="${Compile.ToCopyToBin}">
    <attrib readonly="false">
      <fileset refid="Compile.ToCopy" />
    </attrib>

    <mkdir if="${directory::exists(Compile.Bin) == false}" dir="${Compile.Bin}"/>

    <copy failonerror="true" overwrite="true" flatten="true" todir="${Compile.Bin}" verbose="true">
      <fileset refid="Compile.ToCopy" />
    </copy>
  </target>

  <target name="Private.Compile.DeployZip" if="${Compile.ToDeployZip}">
    <zip zipfile="${Compile.Bin}\${Compile.ZipFileName}">
      <fileset>
        <include name="${Compile.Bin}/**" />
      </fileset>
    </zip>
    <property name="Deployment.SourceFileName" value="${Compile.ZipFileName}"/>
    <property name="Deployment.SourceDir"	value="${Compile.Bin}\" />
    <property name="Deployment.TargetDir"	value="${ArtifactRootDirectory}\${CCNetLabel}" />
    <property name="Deployment.TargetFile"	value="${Deployment.SourceFileName}" />
    <property name="Deployment.FileWebPath"	value="/${ProjectName} Installs/${CCNetLabel}/${Deployment.TargetFile}" />
    <property name="Deployment.FileWebName"	value="${Deployment.TargetFile}" />

    <call target="Deployment.PublishFile"/>
  </target>
  
  <target name="Compile.SetUp">
    <delete dir="${Compile.LogFileDirectory}" if="${directory::exists(Compile.LogFileDirectory)}" />
    <mkdir dir="${Compile.LogFileDirectory}"/>
  </target>

  <target name="Compile.TearDown">

  </target>

</project>