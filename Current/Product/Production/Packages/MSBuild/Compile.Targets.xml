<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Compile">

  <property name="Compile.LogFileDirectory" value="%Compile.LogFileDirectory%" overwrite="false" />
	
	<!--
	The following properties should be specified in the calling script.
	
	<property name="Compile.Bin" value="" />
	<property name="Compile.XmlLogFileName" value="" />
	-->
	
	<!-- The following properties are for internal use only -->
  <property name="Private.Compile.Result" value="" />
    
  <target name="Compile.CompileSource">
    <exec 
	    program="${framework::get-framework-directory('%Compile.DotNetFramework.Version%')}\msbuild.exe" workingdir="${Common.Directory.Product.Path}"
	    failonerror="false"
	    resultproperty="Private.Compile.Result"
      verbose="true"
    >
      <arg line='"${Compile.SolutionFile}"' />
      <arg line='/t:Build' />
      <arg line='/p:Configuration="${Compile.ConfigName}"' />
      <arg line='/noconsolelogger' />
      <arg line='/l:XmlLogger,"${Common.Directory.Packages.Path}\MSBuild\bin\MSBuildLogger.dll";"${Compile.LogFileDirectory}\${Compile.XmlLogFileName}"' />
      <environment refid="${Compile.Environment.RefId}" />
    </exec>
    <copy file="${Compile.LogFileDirectory}\${Compile.XmlLogFileName}" tofile="${Common.Directory.Artifact.Path}\MSBuildLog.xml" if="${Compile.PublishLogFile}"/>
    <if test="${int::parse(Private.Compile.Result) != 0}">
      <fail message='The compilation failed, for details please click the link named "MSBuild Compile Details" on the left.' />
    </if>
    <call target="Private.Compile.CopyToWorkingBin" />
    <call target="Private.Compile.DeployZip" />
  </target>
    
  <target name="Private.Compile.CopyToWorkingBin" if="${Compile.ToCopyToBin}">
    <property name="Deployment.NewCopySourceFolder" value="${Common.Directory.Production.Path}\**\bin\${Compile.ConfigName}\*.*" dynamic="true" />
    <function execute="${fileset::include-add('Compile.ToCopy', Deployment.NewCopySourceFolder)}"/>

    <attrib readonly="false">
      <fileset refid="Compile.ToCopy" />
    </attrib>

    <mkdir if="${directory::exists(Compile.Bin) == false}" dir="${Compile.Bin}"/>

    <copy failonerror="true" overwrite="true" flatten="true" todir="${Compile.Bin}" verbose="true">
      <fileset refid="Compile.ToCopy" />
    </copy>
  </target>

  <target name="Private.Compile.DeployZip" if="${Compile.ToDeployZip}">
    <zip zipfile="${Compile.Bin}\${Compile.ZipFileName}">
      <fileset>
		  <exclude name="${Compile.Bin}/${Compile.ZipFileName}" />
		  <include name="${Compile.Bin}/**" />
      </fileset>
    </zip>
    <property name="Publish.Source.File.Name" value="${Compile.ZipFileName}"/>
    <property name="Publish.Source.Directory.Path"	value="${Compile.Bin}\" />
    <property name="Publish.Target.Directory.Path"	value="${Common.Directory.Artifact.Path}" />
    <property name="Publish.Target.File.Name"	value="${Publish.Source.File.Name}" />
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Target.File.Name}" />
    <property name="Publish.Web.File.Name"	value="${Publish.Target.File.Name}" />

    <call target="Publish.File"/>
  </target>

  <target name="Compile.ShowReport" if="${file::exists(Compile.LogFileDirectory + '\' + Compile.XmlLogFileName)}">
    <delete file="${Compile.LogFileDirectory}\Compile.xml" if="${file::exists(Compile.LogFileDirectory + '\Compile.xml')}" />
    <style 
      in="${Compile.LogFileDirectory}\${Compile.XmlLogFileName}" 
      out="${Compile.LogFileDirectory}\Compile.xml" 
      style="${Common.Directory.Build.Path}\Packages\MSBuild\MSBuildMerge.xsl" />

    <delete file="${Common.Directory.Artifact.Path}\MSBuildReport.html" if="${file::exists(Common.Directory.Artifact.Path + '\MSBuildReport.html')}" />
    <style
      in="${Compile.LogFileDirectory}\${Compile.XmlLogFileName}"
      out="${Common.Directory.Artifact.Path}\MSBuildReport.html"
      style="${Common.Directory.Build.Path}\Packages\MSBuild\msbuild.xsl" />
    
    <property name="Common.ShowReport.XmlFile" value="${Compile.LogFileDirectory}\Compile.xml"/>
    <property name="Common.ShowReport.HtmlFile" value="${Compile.LogFileDirectory}\CompileReport.html"/>
    <property name="Common.ShowReport.XslFile" value="${Common.Directory.Build.Path}\Packages\MSBuild\compile-msbuild.xsl"/>
    <property name="Common.ShowReport.DetailsFilePath" value="${Common.Directory.Artifact.Path}\MSBuildReport.html"/>
    <call target="Common.ShowReport"/>
  </target>
  
  <target name="Compile.SetUp">
    <delete dir="${Compile.LogFileDirectory}" if="${directory::exists(Compile.LogFileDirectory)}" />
    <mkdir dir="${Compile.LogFileDirectory}"/>
  </target>

  <target name="Compile.TearDown">

  </target>

</project>
